# متطلبات الـ Backend لتطبيق "طبيبك"

هذا المستند يوضح جميع الميزات والوظائف في الواجهة الأمامية التي تتطلب دعمًا من جهة الخادم (Backend). الهدف هو توفير خارطة طريق واضحة لمطور الـ Backend لبناء واجهات برمجة التطبيقات (APIs) اللازمة.

---

## 1. نظام المصادقة وإدارة الجلسات (Authentication & Session Management)

الهدف هو استبدال نظام الـ cookies المؤقت بنظام مصادقة حقيقي يعتمد على JWT (JSON Web Tokens).

-   **`POST /api/auth/signup`**
    -   **الوصف:** إنشاء حساب مستخدم جديد (مريض أو طبيب).
    -   **المدخلات (Request Body):** `{ firstName, lastName, email, password, userType: 'patient' | 'doctor', phone? }`
    -   **المنطق:**
        1.  التحقق من أن البريد الإلكتروني غير مسجل مسبقًا.
        2.  تجزئة (hash) كلمة المرور باستخدام خوارزمية آمنة (مثل bcrypt).
        3.  إنشاء سجل جديد في جدول `Users`.
        4.  إذا كان `userType` هو `doctor`، يتم إنشاء سجل مرتبط في جدول `DoctorProfiles` مع حالة توثيق افتراضية `unverified`.
        5.  إنشاء JWT يحتوي على `userId` و `userType`.
        6.  إرجاع الـ token ليتم حفظه في `httpOnly` cookie.
    -   **مخرجات النجاح (Response):** `201 Created` مع بيانات المستخدم الأساسية (بدون كلمة المرور).

-   **`POST /api/auth/login`**
    -   **الوصف:** تسجيل دخول مستخدم موجود.
    -   **المدخلات (Request Body):** `{ email, password }`
    -   **المنطق:**
        1.  البحث عن المستخدم عبر البريد الإلكتروني.
        2.  مقارنة كلمة المرور المُدخلة مع الـ hash المحفوظ في قاعدة البيانات.
        3.  في حال تطابق البيانات، يتم إنشاء JWT وإرجاعه.
    -   **مخرجات النجاح (Response):** `200 OK` مع بيانات المستخدم والـ token.
    -   **مخرجات الفشل (Response):** `401 Unauthorized` في حال كانت البيانات غير صحيحة.

-   **`POST /api/auth/google`**
    -   **الوصف:** التعامل مع تسجيل الدخول عبر جوجل (OAuth 2.0). يتطلب إعداد معرفات عميل جوجل.
    -   **المنطق:**
        1.  توجيه المستخدم إلى صفحة مصادقة جوجل.
        2.  استقبال الـ callback من جوجل بعد نجاح المصادقة.
        3.  البحث عن مستخدم بنفس البريد الإلكتروني في قاعدة البيانات أو إنشاء حساب جديد إذا لم يكن موجودًا.
        4.  إنشاء جلسة (JWT) للمستخدم.
    -   **مخرجات النجاح (Response):** إعادة توجيه المستخدم إلى الصفحة الرئيسية مع الـ token في cookie.

-   **`POST /api/auth/logout`**
    -   **الوصف:** تسجيل خروج المستخدم.
    -   **المنطق:** مسح الـ httpOnly cookie الخاص بالجلسة.

-   **`POST /api/auth/forgot-password`**
    -   **الوصف:** بدء عملية إعادة تعيين كلمة المرور.
    -   **المدخلات (Request Body):** `{ email }`
    -   **المنطق:**
        1.  البحث عن المستخدم عبر البريد الإلكتروني.
        2.  إذا كان موجودًا، يتم إنشاء token فريد لإعادة التعيين بتاريخ صلاحية قصير.
        3.  إرسال بريد إلكتروني للمستخدم يحتوي على رابط لإعادة تعيين كلمة المرور (مثل: `https://yoursite.com/reset-password?token=UNIQUE_TOKEN`).
        4.  يجب أن تكون الاستجابة دائمًا `200 OK` لمنع الكشف عن وجود البريد الإلكتروني في النظام.

-   **`POST /api/auth/reset-password`**
    -   **الوصف:** إتمام عملية إعادة تعيين كلمة المرور.
    -   **المدخلات (Request Body):** `{ token, newPassword }`
    -   **المنطق:**
        1.  التحقق من صحة الـ token وأنه لم تنته صلاحيته.
        2.  تجزئة (hash) كلمة المرور الجديدة.
        3.  تحديث كلمة مرور المستخدم في قاعدة البيانات.
        4.  إبطال الـ token لمنع إعادة استخدامه.
    -   **مخرجات النجاح (Response):** `200 OK`.
    -   **مخرجات الفشل (Response):** `400 Bad Request` إذا كان الـ token غير صالح.

-   **`GET /api/users/me`**
    -   **الوصف:** جلب بيانات المستخدم الحالي المسجل دخوله.
    -   **المنطق:** التحقق من صحة الـ JWT المرسل مع الطلب وإرجاع بيانات المستخدم المرتبطة به.
    -   **مخرجات النجاح (Response):** `200 OK` مع كائن بيانات المستخدم.

---

## 2. إدارة ملفات المستخدمين (User Profile Management)

-   **`PUT /api/doctors/profile`**
    -   **الوصف:** تحديث بيانات الملف الشخصي للطبيب. (يتطلب مصادقة كطبيب).
    -   **المدخلات (Request Body):** `{ fullName, email, phone, city, specialty, bio }`
    -   **المنطق:** تحديث السجل المطابق في جدول `DoctorProfiles`.

-   **`POST /api/users/profile/avatar`**
    -   **الوصف:** رفع وتغيير الصورة الشخصية لأي مستخدم (طبيب أو مريض). (يتطلب مصادقة).
    -   **المنطق:**
        1.  استقبال ملف الصورة.
        2.  رفع الصورة إلى خدمة تخزين سحابي (مثل Firebase Storage أو Google Cloud Storage).
        3.  تحديث حقل `profilePicture` في سجل المستخدم بالرابط الجديد للصورة.
    -   **مخرجات النجاح (Response):** `200 OK` مع رابط الصورة الجديد.

---

## 3. نظام توثيق الأطباء (Doctor Verification System)

-   **`POST /api/doctors/verification`**
    -   **الوصف:** تقديم طلب لتوثيق حساب الطبيب.
    -   **المدخلات (Request Body):** `FormData` تحتوي على ملف صورة كارنيه النقابة.
    -   **المنطق:**
        1.  رفع الصورة إلى مجلد آمن في خدمة التخزين السحابي.
        2.  حفظ رابط الصورة في سجل الطبيب.
        3.  تغيير حالة `verificationStatus` إلى `pending`.
        4.  حفظ تاريخ تقديم الطلب.

-   **`POST /api/admin/verifications/approve`**
    -   **الوصف:** قبول طلب توثيق. (يتطلب مصادقة كمسؤول).
    -   **المدخلات (Request Body):** `{ doctorId }`
    -   **المنطق:** تغيير `verificationStatus` للطبيب المحدد إلى `verified`.

-   **`POST /api/admin/verifications/reject`**
    -   **الوصف:** رفض طلب توثيق. (يتطلب مصادقة كمسؤول).
    -   **المدخلات (Request Body):** `{ doctorId }`
    -   **المنطق:** تغيير `verificationStatus` للطبيب المحدد إلى `rejected`.
    
-   **ملاحظة هامة:** لا يجب أن يظهر الطبيب في نتائج البحث العامة (`GET /api/doctors`) أو يكون ملفه الشخصي متاحًا للعموم إلا بعد أن تصبح حالة التوثيق `verified`.

---

## 4. جلب البيانات (Data Retrieval API)

-   **`GET /api/doctors`**
    -   **الوصف:** جلب قائمة الأطباء مع تطبيق الفلاتر والترتيب.
    -   ** معاملات الاستعلام (Query Params):** `specialty`, `city`, `gender`.
    -   **المنطق:**
        1.  **جلب الأطباء الذين حالة توثيقهم `verified` فقط.**
        2.  تطبيق الفلاتر حسب `specialty`, `city`, `gender`.
        3.  ترتيب النتائج: أولاً حسب باقة الاشتراك (`subscription.tier`) ثم حسب التقييم (`rating`).

-   **`GET /api/doctors/:id`**
    -   **الوصف:** جلب بيانات ملف شخصي كامل لطبيب واحد.
    -   **المنطق:** يجب أن يكون الطبيب موثقًا (`verified`). إذا لم يكن كذلك، يتم إرجاع `404 Not Found`.

-   **`GET /api/specialties`** & **`GET /api/cities`**
    -   **الوصف:** جلب قائمة فريدة بجميع التخصصات والمدن المتاحة من قاعدة البيانات.

-   **`GET /api/admin/users`**
    -   **الوصف:** جلب قائمة بجميع المستخدمين (أطباء ومرضى) للمسؤول. (يتطلب مصادقة كمسؤول).

-   **`GET /api/admin/verifications/pending`**
    -   **الوصف:** جلب قائمة بالأطباء الذين ينتظرون التوثيق. (يتطلب مصادقة كمسؤول).

---

## 5. نظام التقييمات (Reviews System)

-   **`POST /api/doctors/:id/reviews`**
    -   **الوصف:** إضافة تقييم جديد لطبيب. (يتطلب مصادقة كمريض).
    -   **المدخلات (Request Body):** `{ rating: number, text: string }`
    -   **المنطق:**
        1.  إنشاء سجل جديد في جدول `Reviews` مرتبط بالطبيب والمريض.
        2.  (موصى به) إعادة حساب متوسط تقييم الطبيب (`rating`) وعدد التقييمات (`reviews`) وتحديثها في سجل الطبيب.

---

## 6. ربط ميزات الذكاء الاصطناعي (AI Features Integration)

-   **`recommendDoctorAction` (مرشدك الطبي الذكي):**
    -   قبل استدعاء `aiDoctorMatch` flow، يجب على الـ Backend جلب قائمة بأسماء وتخصصات جميع الأطباء **الموثقين (`verified`) فقط** من قاعدة البيانات وتمريرها كـ `doctorList` إلى الـ flow.

-   **`sendWelcomeMessageAction` (إرسال رسائل ترحيبية):**
    -   يجب دمج خدمة إرسال بريد إلكتروني (مثل SendGrid, Mailgun).
    -   بعد أن يقوم `generateWelcomeMessage` flow بإنشاء نص وعنوان الرسالة، يجب على الـ Backend استخدام خدمة البريد الإلكتروني لإرسالها فعليًا إلى بريد المستخدم.

-   **`analyzePrescriptionAction` (مفسّر الروشتات):**
    -   **الوصف:** هذه الميزة تتطلب نقطة نهاية (Endpoint) لاستقبال صورة الروشتة.
    -   **المدخلات (Request Body):** `FormData` تحتوي على ملف صورة الروشتة (`prescriptionImage`).
    -   **المنطق:**
        1.  يستقبل الـ Backend الصورة.
        2.  يقوم بتحويل الصورة إلى صيغة Data URI (base64).
        3.  يستدعي `analyzePrescription` flow مع الـ Data URI كمدخل.
        4.  يعيد الـ Backend النتيجة (بصيغة JSON) التي تم الحصول عليها من الـ flow إلى الواجهة الأمامية.
    -   **Endpoint المقترح:** `POST /api/ai/interpret-prescription`

---

## 7. نظام الإبلاغ عن الأدوية الناقصة

-   **`POST /api/medications/report-missing`**
    -   **الوصف:** السماح للمستخدمين بالإبلاغ عن دواء لا يمكنهم العثور عليه.
    -   **المدخلات (Request Body):** `{ medicationName: string, userId?: string, location?: string }`
    -   **المنطق:**
        1.  تسجيل الطلب في جدول `MissingMedicationRequests` مع اسم الدواء، هوية المستخدم (إذا كان مسجلاً)، الموقع (اختياري)، والطابع الزمني.
        2.  (متقدم) يمكن للنظام تجميع هذه الطلبات لتحديد النواقص المنتشرة على نطاق واسع.
        3.  (متقدم) يمكن ربط النظام بواجهات برمجية لمخزون الصيدليات للتحقق من التوافر في منطقة المستخدم وإخطاره.
    -   **مخرجات النجاح (Response):** `202 Accepted` مع رسالة تأكيد.

---

## 8. نظام الإعلانات (Ads System)

-   **`GET /api/ads`**
    -   **الوصف:** جلب الإعلانات.
    -   **معاملات الاستعلام (Query Params):** `placement: 'homepage-sidebar' | 'search-results'`, `status: 'active'`.
-   **`POST /api/admin/ads`**
    -   **الوصف:** إنشاء إعلان جديد (يتطلب مصادقة كمسؤول).
    -   **المدخلات (Request Body):** `{ type: 'image' | 'text', title, description, link, placement, status, imageUrl? }`.
-   **`PUT /api/admin/ads/:id`**
    -   **الوصف:** تحديث إعلان موجود (يتطلب مصادقة كمسؤول).
-   **`DELETE /api/admin/ads/:id`**
    -   **الوصف:** حذف إعلان (يتطلب مصادقة كمسؤول).

---

## 9. نظام الاشتراكات (Subscriptions - للمستقبل)

-   **المنطق:**
    -   التكامل مع بوابة دفع (مثل Stripe).
    -   إنشاء Endpoints لإدارة عمليات الدفع وتحديث حالة اشتراك الطبيب (`subscription.tier` و `subscription.status`) في قاعدة البيانات.
    -   إنشاء Webhook endpoint لاستقبال الإشعارات من بوابة الدفع (مثل نجاح الدفع، انتهاء الاشتراك).
